# Deadman's Drop - Development Progress

## Completed Tasks

### Task 1: Initialize Node.js + TypeScript project (2026-01-17)
- Created server directory structure
- Created package.json with all required dependencies:
  - Express.js, TypeScript 5+, Prisma ORM
  - Passport.js with JWT, Multer, node-cron
  - Firebase Admin SDK, bcrypt, cors, helmet, morgan
- Created tsconfig.json with strict mode enabled
- Created src/index.ts entry point
- Verified pnpm install completes without errors
- Verified pnpm run build compiles TypeScript successfully
- Added .gitignore for node_modules, dist, env files
- Switched to pnpm (updated PRD accordingly)

### Task 2: Set up Express.js server with middleware (2026-01-17)
- Configured Express.js with essential middleware:
  - helmet: Security headers (CSP, HSTS, X-Frame-Options, etc.)
  - cors: Cross-Origin Resource Sharing enabled
  - morgan: Request logging in 'combined' format
- Added body parsing middleware (json, urlencoded)
- Added health check endpoint at /health
- Added 404 handler for undefined routes
- Added global error handler
- Port configurable via PORT environment variable (default: 3000)
- Verified: server starts, CORS headers present, security headers applied, logging works

### Task 3: Configure PostgreSQL connection (2026-01-17)
- Initialized Prisma with `pnpm prisma init`
- Configured PostgreSQL as the database provider in schema.prisma
- Created src/db.ts with:
  - PrismaClient singleton with configurable logging (verbose in dev, minimal in prod)
  - connectDatabase() function for startup connection
  - disconnectDatabase() function for graceful shutdown
- Updated src/index.ts to:
  - Connect to database on startup
  - Handle graceful shutdown on SIGTERM/SIGINT
  - Exit with error code if database connection fails
- Created .env.example with DATABASE_URL template
- Added SystemConfig placeholder model to enable Prisma client generation
- Verified: pnpm run build compiles successfully, pnpm test passes

### Task 4: Create database schema migrations (2026-01-17)
- Updated prisma/schema.prisma with all data models from PRD section 4:
  - User: UUID id, username, password_hash, is_admin, storage quota/usage, timer settings, FCM token
  - Video: UUID id, user relation, title, file path/size/mime, status enum, distribution timestamps, public token
  - DistributionRecipient: UUID id, user relation, email, name
  - CheckIn: UUID id, video relation, action enum (PREVENT/ALLOW_DISTRIBUTION)
  - SystemConfig: key-value pairs with timestamps
- Created enums: VideoStatus (PENDING, ACTIVE, DISTRIBUTED, EXPIRED), CheckInAction
- Added appropriate indexes for queries (userId, status, distributeAt, publicToken)
- Configured cascade deletes for related records
- Created initial migration: prisma/migrations/20260117000000_initial_schema/migration.sql
- Created rollback migration: prisma/migrations/20260117000000_initial_schema/down.sql
- Created migration_lock.toml for PostgreSQL provider
- Verified: schema validates, Prisma client generates, TypeScript builds

### Task 5: Set up environment variable management (2026-01-17)
- Added dotenv package (v17.2.3) for .env file loading
- Created src/config.ts with:
  - ConfigurationError class for validation errors
  - getRequired() and getOptional() helper functions
  - loadConfig() function to load and validate all environment variables
  - initializeConfig() function for application startup (exits on error)
  - getConfig() singleton accessor
- Updated .env.example with comprehensive documentation:
  - SERVER: PORT, NODE_ENV
  - DATABASE: DATABASE_URL (required)
  - AUTHENTICATION: JWT_SECRET (required), JWT_EXPIRES_IN
  - STORAGE: STORAGE_PATH, MAX_FILE_SIZE_MB
  - FIREBASE: Optional push notification credentials
- Updated src/index.ts to:
  - Initialize config before other imports that depend on it
  - Use config.port instead of process.env.PORT
- Updated src/db.ts to use config.isDevelopment for logging level
- Verified: missing required variables cause clear startup failure
- Verified: pnpm run build compiles successfully, pnpm test passes

### Task 6: Configure file storage path (2026-01-17)
- Created src/storage.ts with:
  - StorageError class for initialization errors
  - StorageConfig interface with rootPath and maxFileSizeBytes
  - resolveStoragePath() to handle both absolute and relative paths
  - ensureDirectoryExists() to create directory with recursive parent creation
  - verifyWritePermissions() to test write access via temp file creation
  - initializeStorage() main function called at startup
  - getStorageConfig() singleton accessor
  - Helper functions: getVideoPath(), getUserStoragePath(), ensureUserStorageDirectory()
- Updated src/index.ts to:
  - Import and call initializeStorage() during startup
  - Handle StorageError with clear error message and exit
  - Storage initialized before database connection
- Storage path configurable via STORAGE_PATH environment variable (already in .env.example)
- Supports absolute paths (e.g., /mnt/nas/deadmans-drop) or relative paths (e.g., ./uploads)
- Verified: pnpm run build compiles successfully, pnpm test passes

### Task 7: Create Docker configuration (2026-01-17)
- Created server/Dockerfile with multi-stage build:
  - Build stage: Uses node:20-alpine, installs pnpm, compiles TypeScript, generates Prisma client
  - Production stage: Minimal image with only production dependencies
  - Non-root user (deadman:nodejs) for security
  - Health check configured for /health endpoint
  - Default environment variables for production
- Created server/docker-compose.yml for local development:
  - PostgreSQL 15 service with health check and persistent volume
  - Application service with dependency on healthy database
  - Environment variables pre-configured for development
  - Separate volumes for database data and uploads
  - Port mapping: 3000 for app, 5432 for database
- Created server/.dockerignore to exclude:
  - node_modules, dist directories
  - Environment files, git files
  - IDE/editor files, logs
  - Test files and coverage
- Verified: docker compose config validates successfully
- Verified: pnpm run build compiles successfully, pnpm test passes

### Task 8: Set up logging framework (2026-01-17)
- Installed pino (v10.2.0) and pino-pretty (v13.1.3) for structured logging
- Installed pino-http (v11.0.0) for Express request logging
- Removed morgan package (replaced by pino-http)
- Created src/logger.ts with:
  - Configurable log levels (trace, debug, info, warn, error, fatal, silent)
  - Environment-based defaults: "debug" in development, "info" in production
  - Pretty-printed output for development (colorized, human-readable)
  - JSON output for production (machine-parseable)
  - Optional file logging with LOG_FILE environment variable
  - Child logger support via createChildLogger() for component-specific context
  - Timestamp included in all log entries
- Updated src/index.ts:
  - Replaced morgan with pino-http middleware
  - Integrated request logging with main pino logger
  - Health check requests excluded from logging to reduce noise
  - All console.log/console.error replaced with structured logger calls
- Updated src/config.ts:
  - Added note explaining console.log usage (config loads before logger)
  - Added [config] prefix to console logs for clarity
- Updated src/db.ts:
  - Created child logger for database component
  - Wired Prisma logging events (query, info, warn, error) to pino
  - Database queries logged at debug level with duration
- Updated src/storage.ts:
  - Created child logger for storage component
  - All console.log replaced with structured logger calls
- Updated .env.example with logging configuration:
  - LOG_LEVEL: trace, debug, info, warn, error, fatal, silent
  - LOG_PRETTY: true/false for pretty vs JSON output
  - LOG_FILE: optional path for file logging
- Verified: pnpm run build compiles successfully, pnpm test passes

### Task 9: Implement user model with password hashing (2026-01-18)
- Created src/services/user.service.ts with comprehensive user management:
  - hashPassword(): Hashes passwords using bcrypt with configurable rounds
  - verifyPassword(): Securely verifies passwords against stored hashes
  - createUser(): Creates users with hashed passwords (never stores plaintext)
  - validateCredentials(): Validates login credentials with timing-attack protection
  - findUserByUsername(), findUserById(): User lookup functions
  - updatePassword(): Updates user password with proper hashing
  - getAllUsers(), updateUser(), deleteUser(): Admin user management functions
- Password hashing configuration:
  - BCRYPT_ROUNDS environment variable (default: 12, minimum: 10)
  - Configurable via src/config.ts with validation
  - Documented in .env.example with security recommendations
- Security features:
  - Constant-time comparison to prevent timing attacks on username enumeration
  - Minimum 10 rounds enforced even if lower value configured
  - Passwords never logged (only user IDs and usernames in logs)
- Verified: pnpm run build compiles successfully, pnpm test passes

### Task 10: Set up Passport.js with JWT strategy (2026-01-18)
- Created src/auth/ directory with authentication modules:
  - jwt.service.ts: JWT token generation and verification
    - generateToken(): Creates JWT with user ID, username, isAdmin
    - verifyToken(): Validates and decodes JWT tokens
    - isTokenExpiring(): Checks if token is near expiration
    - extractTokenFromHeader(): Parses Bearer token from Authorization header
  - passport.ts: Passport.js configuration
    - JWT strategy configured with HS256 algorithm
    - Token extracted from Authorization header (Bearer scheme)
    - User lookup from database on each authenticated request
    - AuthenticatedUser type excludes passwordHash for security
  - index.ts: Module exports for clean imports
- Updated src/index.ts:
  - Imported and configured Passport at startup
  - Added passport.initialize() middleware
- Token configuration:
  - JWT_SECRET (required): Secret key for signing tokens
  - JWT_EXPIRES_IN (optional, default: '7d'): Token expiration
  - Supports formats: '7d', '24h', '60m', '3600s', or seconds
- TypeScript type augmentation for Express.Request.user
- Verified: pnpm run build compiles successfully, pnpm test passes

### Task 11: Implement login endpoint (2026-01-18)
- Created src/routes/auth.routes.ts with POST /api/auth/login endpoint:
  - Validates required fields (username, password)
  - Returns 400 for missing/empty fields
  - Uses validateCredentials() from user service for authentication
  - Returns 401 for invalid credentials (constant-time to prevent timing attacks)
  - On success, generates JWT token using jwt.service
  - Returns token and user info matching API specification:
    - { token: string, user: { id, username, is_admin } }
- Created src/routes/index.ts to export route modules
- Updated src/index.ts:
  - Imported authRoutes from routes module
  - Mounted auth routes at /api/auth
- All error cases logged appropriately
- Verified: pnpm run build compiles successfully, pnpm test passes

### Task 12: Implement token refresh endpoint (2026-01-18)
- Created POST /api/auth/refresh endpoint in src/routes/auth.routes.ts:
  - Validates required token field (returns 400 if missing/empty)
  - Verifies existing token using jwt.service.verifyToken()
  - Rejects expired tokens with 401 and appropriate error message
  - Verifies user still exists in database (prevents token refresh for deleted users)
  - Generates new JWT token with fresh expiration on success
  - Returns { token: string } matching API specification
- Imported findUserById from user.service for user existence verification
- Imported verifyToken and DecodedToken from jwt.service
- All error cases logged appropriately
- Verified: pnpm run build compiles successfully, pnpm test passes

### Task 13: Create authentication middleware (2026-01-18)
- Created src/auth/middleware.ts with authentication middleware:
  - requireAuth(): Express middleware that validates JWT tokens via Passport
    - Returns 401 Unauthorized if no token, invalid token, or user not found
    - Attaches authenticated user to req.user on success
    - Uses Passport's JWT strategy configured in Task 10
    - Logs authentication failures with reason for debugging
  - isAuthenticated(): Type guard for TypeScript type narrowing
  - getAuthenticatedUser(): Helper to get user from request (throws if not authenticated)
- Updated src/auth/index.ts to export new middleware functions
- Middleware properly chains with existing Passport configuration
- All error cases logged appropriately with structured logging
- Verified: pnpm run build compiles successfully, pnpm test passes

## Next Task
Task 14: Create admin authorization middleware
