# Deadman's Drop - Development Progress

## Completed Tasks

### Task 1: Initialize Node.js + TypeScript project (2026-01-17)
- Created server directory structure
- Created package.json with all required dependencies:
  - Express.js, TypeScript 5+, Prisma ORM
  - Passport.js with JWT, Multer, node-cron
  - Firebase Admin SDK, bcrypt, cors, helmet, morgan
- Created tsconfig.json with strict mode enabled
- Created src/index.ts entry point
- Verified pnpm install completes without errors
- Verified pnpm run build compiles TypeScript successfully
- Added .gitignore for node_modules, dist, env files
- Switched to pnpm (updated PRD accordingly)

### Task 2: Set up Express.js server with middleware (2026-01-17)
- Configured Express.js with essential middleware:
  - helmet: Security headers (CSP, HSTS, X-Frame-Options, etc.)
  - cors: Cross-Origin Resource Sharing enabled
  - morgan: Request logging in 'combined' format
- Added body parsing middleware (json, urlencoded)
- Added health check endpoint at /health
- Added 404 handler for undefined routes
- Added global error handler
- Port configurable via PORT environment variable (default: 3000)
- Verified: server starts, CORS headers present, security headers applied, logging works

### Task 3: Configure PostgreSQL connection (2026-01-17)
- Initialized Prisma with `pnpm prisma init`
- Configured PostgreSQL as the database provider in schema.prisma
- Created src/db.ts with:
  - PrismaClient singleton with configurable logging (verbose in dev, minimal in prod)
  - connectDatabase() function for startup connection
  - disconnectDatabase() function for graceful shutdown
- Updated src/index.ts to:
  - Connect to database on startup
  - Handle graceful shutdown on SIGTERM/SIGINT
  - Exit with error code if database connection fails
- Created .env.example with DATABASE_URL template
- Added SystemConfig placeholder model to enable Prisma client generation
- Verified: pnpm run build compiles successfully, pnpm test passes

### Task 4: Create database schema migrations (2026-01-17)
- Updated prisma/schema.prisma with all data models from PRD section 4:
  - User: UUID id, username, password_hash, is_admin, storage quota/usage, timer settings, FCM token
  - Video: UUID id, user relation, title, file path/size/mime, status enum, distribution timestamps, public token
  - DistributionRecipient: UUID id, user relation, email, name
  - CheckIn: UUID id, video relation, action enum (PREVENT/ALLOW_DISTRIBUTION)
  - SystemConfig: key-value pairs with timestamps
- Created enums: VideoStatus (PENDING, ACTIVE, DISTRIBUTED, EXPIRED), CheckInAction
- Added appropriate indexes for queries (userId, status, distributeAt, publicToken)
- Configured cascade deletes for related records
- Created initial migration: prisma/migrations/20260117000000_initial_schema/migration.sql
- Created rollback migration: prisma/migrations/20260117000000_initial_schema/down.sql
- Created migration_lock.toml for PostgreSQL provider
- Verified: schema validates, Prisma client generates, TypeScript builds

### Task 5: Set up environment variable management (2026-01-17)
- Added dotenv package (v17.2.3) for .env file loading
- Created src/config.ts with:
  - ConfigurationError class for validation errors
  - getRequired() and getOptional() helper functions
  - loadConfig() function to load and validate all environment variables
  - initializeConfig() function for application startup (exits on error)
  - getConfig() singleton accessor
- Updated .env.example with comprehensive documentation:
  - SERVER: PORT, NODE_ENV
  - DATABASE: DATABASE_URL (required)
  - AUTHENTICATION: JWT_SECRET (required), JWT_EXPIRES_IN
  - STORAGE: STORAGE_PATH, MAX_FILE_SIZE_MB
  - FIREBASE: Optional push notification credentials
- Updated src/index.ts to:
  - Initialize config before other imports that depend on it
  - Use config.port instead of process.env.PORT
- Updated src/db.ts to use config.isDevelopment for logging level
- Verified: missing required variables cause clear startup failure
- Verified: pnpm run build compiles successfully, pnpm test passes

### Task 6: Configure file storage path (2026-01-17)
- Created src/storage.ts with:
  - StorageError class for initialization errors
  - StorageConfig interface with rootPath and maxFileSizeBytes
  - resolveStoragePath() to handle both absolute and relative paths
  - ensureDirectoryExists() to create directory with recursive parent creation
  - verifyWritePermissions() to test write access via temp file creation
  - initializeStorage() main function called at startup
  - getStorageConfig() singleton accessor
  - Helper functions: getVideoPath(), getUserStoragePath(), ensureUserStorageDirectory()
- Updated src/index.ts to:
  - Import and call initializeStorage() during startup
  - Handle StorageError with clear error message and exit
  - Storage initialized before database connection
- Storage path configurable via STORAGE_PATH environment variable (already in .env.example)
- Supports absolute paths (e.g., /mnt/nas/deadmans-drop) or relative paths (e.g., ./uploads)
- Verified: pnpm run build compiles successfully, pnpm test passes

### Task 7: Create Docker configuration (2026-01-17)
- Created server/Dockerfile with multi-stage build:
  - Build stage: Uses node:20-alpine, installs pnpm, compiles TypeScript, generates Prisma client
  - Production stage: Minimal image with only production dependencies
  - Non-root user (deadman:nodejs) for security
  - Health check configured for /health endpoint
  - Default environment variables for production
- Created server/docker-compose.yml for local development:
  - PostgreSQL 15 service with health check and persistent volume
  - Application service with dependency on healthy database
  - Environment variables pre-configured for development
  - Separate volumes for database data and uploads
  - Port mapping: 3000 for app, 5432 for database
- Created server/.dockerignore to exclude:
  - node_modules, dist directories
  - Environment files, git files
  - IDE/editor files, logs
  - Test files and coverage
- Verified: docker compose config validates successfully
- Verified: pnpm run build compiles successfully, pnpm test passes

### Task 8: Set up logging framework (2026-01-17)
- Installed pino (v10.2.0) and pino-pretty (v13.1.3) for structured logging
- Installed pino-http (v11.0.0) for Express request logging
- Removed morgan package (replaced by pino-http)
- Created src/logger.ts with:
  - Configurable log levels (trace, debug, info, warn, error, fatal, silent)
  - Environment-based defaults: "debug" in development, "info" in production
  - Pretty-printed output for development (colorized, human-readable)
  - JSON output for production (machine-parseable)
  - Optional file logging with LOG_FILE environment variable
  - Child logger support via createChildLogger() for component-specific context
  - Timestamp included in all log entries
- Updated src/index.ts:
  - Replaced morgan with pino-http middleware
  - Integrated request logging with main pino logger
  - Health check requests excluded from logging to reduce noise
  - All console.log/console.error replaced with structured logger calls
- Updated src/config.ts:
  - Added note explaining console.log usage (config loads before logger)
  - Added [config] prefix to console logs for clarity
- Updated src/db.ts:
  - Created child logger for database component
  - Wired Prisma logging events (query, info, warn, error) to pino
  - Database queries logged at debug level with duration
- Updated src/storage.ts:
  - Created child logger for storage component
  - All console.log replaced with structured logger calls
- Updated .env.example with logging configuration:
  - LOG_LEVEL: trace, debug, info, warn, error, fatal, silent
  - LOG_PRETTY: true/false for pretty vs JSON output
  - LOG_FILE: optional path for file logging
- Verified: pnpm run build compiles successfully, pnpm test passes

### Task 9: Implement user model with password hashing (2026-01-18)
- Created src/services/user.service.ts with comprehensive user management:
  - hashPassword(): Hashes passwords using bcrypt with configurable rounds
  - verifyPassword(): Securely verifies passwords against stored hashes
  - createUser(): Creates users with hashed passwords (never stores plaintext)
  - validateCredentials(): Validates login credentials with timing-attack protection
  - findUserByUsername(), findUserById(): User lookup functions
  - updatePassword(): Updates user password with proper hashing
  - getAllUsers(), updateUser(), deleteUser(): Admin user management functions
- Password hashing configuration:
  - BCRYPT_ROUNDS environment variable (default: 12, minimum: 10)
  - Configurable via src/config.ts with validation
  - Documented in .env.example with security recommendations
- Security features:
  - Constant-time comparison to prevent timing attacks on username enumeration
  - Minimum 10 rounds enforced even if lower value configured
  - Passwords never logged (only user IDs and usernames in logs)
- Verified: pnpm run build compiles successfully, pnpm test passes

### Task 10: Set up Passport.js with JWT strategy (2026-01-18)
- Created src/auth/ directory with authentication modules:
  - jwt.service.ts: JWT token generation and verification
    - generateToken(): Creates JWT with user ID, username, isAdmin
    - verifyToken(): Validates and decodes JWT tokens
    - isTokenExpiring(): Checks if token is near expiration
    - extractTokenFromHeader(): Parses Bearer token from Authorization header
  - passport.ts: Passport.js configuration
    - JWT strategy configured with HS256 algorithm
    - Token extracted from Authorization header (Bearer scheme)
    - User lookup from database on each authenticated request
    - AuthenticatedUser type excludes passwordHash for security
  - index.ts: Module exports for clean imports
- Updated src/index.ts:
  - Imported and configured Passport at startup
  - Added passport.initialize() middleware
- Token configuration:
  - JWT_SECRET (required): Secret key for signing tokens
  - JWT_EXPIRES_IN (optional, default: '7d'): Token expiration
  - Supports formats: '7d', '24h', '60m', '3600s', or seconds
- TypeScript type augmentation for Express.Request.user
- Verified: pnpm run build compiles successfully, pnpm test passes

### Task 11: Implement login endpoint (2026-01-18)
- Created src/routes/auth.routes.ts with POST /api/auth/login endpoint:
  - Validates required fields (username, password)
  - Returns 400 for missing/empty fields
  - Uses validateCredentials() from user service for authentication
  - Returns 401 for invalid credentials (constant-time to prevent timing attacks)
  - On success, generates JWT token using jwt.service
  - Returns token and user info matching API specification:
    - { token: string, user: { id, username, is_admin } }
- Created src/routes/index.ts to export route modules
- Updated src/index.ts:
  - Imported authRoutes from routes module
  - Mounted auth routes at /api/auth
- All error cases logged appropriately
- Verified: pnpm run build compiles successfully, pnpm test passes

### Task 12: Implement token refresh endpoint (2026-01-18)
- Created POST /api/auth/refresh endpoint in src/routes/auth.routes.ts:
  - Validates required token field (returns 400 if missing/empty)
  - Verifies existing token using jwt.service.verifyToken()
  - Rejects expired tokens with 401 and appropriate error message
  - Verifies user still exists in database (prevents token refresh for deleted users)
  - Generates new JWT token with fresh expiration on success
  - Returns { token: string } matching API specification
- Imported findUserById from user.service for user existence verification
- Imported verifyToken and DecodedToken from jwt.service
- All error cases logged appropriately
- Verified: pnpm run build compiles successfully, pnpm test passes

### Task 13: Create authentication middleware (2026-01-18)
- Created src/auth/middleware.ts with authentication middleware:
  - requireAuth(): Express middleware that validates JWT tokens via Passport
    - Returns 401 Unauthorized if no token, invalid token, or user not found
    - Attaches authenticated user to req.user on success
    - Uses Passport's JWT strategy configured in Task 10
    - Logs authentication failures with reason for debugging
  - isAuthenticated(): Type guard for TypeScript type narrowing
  - getAuthenticatedUser(): Helper to get user from request (throws if not authenticated)
- Updated src/auth/index.ts to export new middleware functions
- Middleware properly chains with existing Passport configuration
- All error cases logged appropriately with structured logging
- Verified: pnpm run build compiles successfully, pnpm test passes

### Task 14: Create admin authorization middleware (2026-01-18)
- Created requireAdmin middleware in src/auth/middleware.ts:
  - Checks if authenticated user has isAdmin: true
  - Returns 403 Forbidden with message "Admin privileges required" for non-admin users
  - Returns 401 Unauthorized if called without prior authentication (safety check)
  - Properly chains with requireAuth middleware (must be used after requireAuth)
  - Logs admin access attempts with user ID, username, path for auditing
- Created isAdmin() type guard helper function:
  - Returns boolean indicating if current user is an admin
  - Useful for TypeScript type narrowing in route handlers
- Updated src/auth/index.ts to export:
  - requireAdmin middleware
  - isAdmin helper function
- Usage pattern: app.get('/api/admin/users', requireAuth, requireAdmin, handler)
- Verified: pnpm run build compiles successfully, pnpm test passes

### Task 15: Write authentication unit tests (2026-01-18)
- Set up Jest testing framework with proper configuration:
  - Created jest.config.js with ts-jest preset for TypeScript support
  - Created src/test/setup.ts with test environment variables
  - Created src/test/mocks.ts with mock helpers (mockConfig, createMockUser, createMockAdminUser)
- Created comprehensive unit tests for JWT service (src/auth/jwt.service.test.ts):
  - Tests for generateToken() - token generation, payload content, expiration
  - Tests for verifyToken() - valid tokens, invalid tokens, expired tokens, tampered signatures
  - Tests for isTokenExpiring() - fresh tokens, expiring tokens, custom buffer time
  - Tests for getTokenExpirationSeconds() - parsing various time formats (days, hours, minutes, seconds)
  - Tests for extractTokenFromHeader() - Bearer token extraction, edge cases
- Created comprehensive unit tests for user service (src/services/user.service.test.ts):
  - Tests for hashPassword() - bcrypt hashing, hash format verification
  - Tests for verifyPassword() - correct/incorrect password verification
  - Tests for createUser() - hashed password storage, admin flag, storage quota
  - Tests for findUserByUsername() and findUserById() - user lookup
  - Tests for validateCredentials() - credential validation, timing attack prevention
  - Tests for updatePassword(), getAllUsers(), deleteUser(), updateUser()
- Created comprehensive unit tests for authentication middleware (src/auth/middleware.test.ts):
  - Tests for requireAuth() - success path, 401 on invalid token, 500 on error
  - Tests for requireAdmin() - admin access granted/denied, 403 for non-admin, 401 if unauthenticated
  - Tests for isAuthenticated(), getAuthenticatedUser(), isAdmin() helpers
- Created comprehensive unit tests for auth routes (src/routes/auth.routes.test.ts):
  - Tests for POST /login - validation, success, invalid credentials, error handling
  - Tests for POST /refresh - token validation, user existence check, new token generation
- Total: 83 tests, all passing
- Verified: pnpm run build compiles successfully, pnpm test passes (83 tests)

### Task 16: Configure Multer for file uploads (2026-01-18)
- Created src/middleware/upload.ts with comprehensive Multer configuration:
  - UploadError class for upload-specific error handling with status codes
  - ALLOWED_VIDEO_MIME_TYPES: video/mp4, video/quicktime (iOS), video/webm, video/3gpp, etc.
  - ALLOWED_VIDEO_EXTENSIONS: .mp4, .mov, .webm, .3gp, .avi, .mkv, etc.
  - videoFileFilter(): Validates both MIME type and extension for security
  - generateUniqueFilename(): Creates UUID-based filenames preserving original extension
  - createDiskStorage(): Multer disk storage with user-specific directories
  - createUploadMiddleware(): Creates configured Multer instance with file size limits
  - getUploadMiddleware(): Singleton accessor for Multer instance
  - handleUploadError(): Express error middleware for proper HTTP error responses
    - LIMIT_FILE_SIZE → 413 with max size message
    - LIMIT_FILE_COUNT → 400 (only single file allowed)
    - LIMIT_UNEXPECTED_FILE → 400 (must use "video" field name)
  - cleanupUploadedFile(): Helper to remove files after failed uploads
  - getTempUploadPath(): Helper for temporary upload directory
- Created src/middleware/index.ts to export all middleware
- File size limits enforced via existing MAX_FILE_SIZE_MB config (default 500 MB)
- Files stored in user-specific subdirectories (userId/uuid.ext)
- Created comprehensive unit tests (src/middleware/upload.test.ts):
  - Tests for ALLOWED_VIDEO_MIME_TYPES and ALLOWED_VIDEO_EXTENSIONS
  - Tests for videoFileFilter() - valid files, invalid MIME, invalid extension, case handling
  - Tests for generateUniqueFilename() - UUID format, extension preservation, uniqueness
  - Tests for UploadError - default/custom status codes, inheritance
  - Tests for handleUploadError() - all Multer error codes, custom errors, passthrough
- Total: 106 tests, all passing
- Verified: pnpm run build compiles successfully, pnpm test passes (106 tests)

### Task 17: Implement video upload endpoint (2026-01-18)
- Created src/services/video.service.ts with video management functions:
  - createVideo(): Creates video record with auto-generated public token
  - findVideoById(), findVideoByPublicToken(): Video lookup functions
  - getVideosByUser(): List videos with pagination and status filtering
  - updateVideoTitle(), deleteVideo(): Video CRUD operations
  - checkUserStorageQuota(): Validates file fits within user's remaining quota
  - updateUserStorageUsage(): Updates user's storage_used_bytes after upload
  - getUserDefaultTimerDays(): Gets user's timer setting for distribution calculation
- Created src/routes/video.routes.ts with POST /api/videos/upload endpoint:
  - Requires authentication via requireAuth middleware
  - Pre-upload quota check rejects users with no remaining quota (413)
  - Uses Multer middleware for multipart/form-data handling
  - Post-upload quota validation ensures file fits in remaining space
  - Cleans up uploaded file on any error (quota exceeded, server error)
  - Auto-generates title as "Video YYYY-MM-DD HH:MM" if not provided
  - Calculates distribute_at based on user's default_timer_days setting
  - Stores relative file path for portability across systems
  - Response includes: id, title, file_size_bytes, mime_type, status, distribute_at, public_token
- Updated src/routes/index.ts to export videoRoutes
- Updated src/index.ts to mount video routes at /api/videos
- Verified: pnpm run build compiles successfully, pnpm test passes (106 tests)

### Task 18: Add file size and quota validation (2026-01-18)
- This task was already implemented as part of Task 17 (video upload endpoint)
- File size limits enforced via Multer configuration:
  - MAX_FILE_SIZE_MB environment variable (default 500 MB)
  - Multer's limits.fileSize setting in upload.ts
  - LIMIT_FILE_SIZE error returns 413 with max size message
- User quota validation in video.routes.ts:
  - Pre-upload check rejects users with no remaining quota (413)
  - Post-upload check validates file fits in remaining space
  - Returns 413 with detailed quota information on failure
- Error messages include:
  - File size (human-readable format)
  - Quota limit (bytes)
  - Used storage (bytes)
  - Remaining storage (bytes)
- Existing tests in upload.test.ts verify LIMIT_FILE_SIZE handling
- Verified: pnpm run build compiles successfully, pnpm test passes (106 tests)

### Task 19: Generate public token for videos (2026-01-18)
- Public token generation already implemented via Prisma schema:
  - schema.prisma line 54: `publicToken String @unique @default(uuid()) @map("public_token") @db.Uuid`
  - Prisma auto-generates UUID v4 for each video on creation
  - Token is indexed for fast lookups: `@@index([publicToken])`
- Token included in upload response (video.routes.ts line 184):
  - Response includes `public_token: video.publicToken`
- Created comprehensive video service tests (src/services/video.service.test.ts):
  - Tests for createVideo() - verifies publicToken is returned
  - Tests for findVideoById() and findVideoByPublicToken()
  - Tests for getVideosByUser() with pagination and filtering
  - Tests for updateVideoTitle() and deleteVideo()
  - Tests for updateUserStorageUsage() and checkUserStorageQuota()
  - Tests for getUserDefaultTimerDays()
  - Specific tests for public token generation verifying UUID format
- Total: 136 tests, all passing (30 new video service tests)
- Verified: pnpm run build compiles successfully, pnpm test passes (136 tests)

### Task 20: Auto-generate video titles (2026-01-18)
- Created src/utils/title-generator.ts with generateAutoTitle() function:
  - Generates title format: "Video YYYY-MM-DD HH:MM" or "Video YYYY-MM-DD HH:MM - Location"
  - Optional location parameter for including location data from mobile devices
  - Location is trimmed and truncated to 50 characters max
  - Second optional date parameter for testing purposes
- Created src/utils/index.ts to export utility functions
- Updated src/routes/video.routes.ts:
  - Import generateAutoTitle from utils module
  - Accept optional "location" field in multipart/form-data request
  - When no title is provided, auto-generate using timestamp and optional location
  - User-provided titles are preserved (takes precedence over auto-generation)
  - Updated API documentation to include location field
- Created comprehensive unit tests (src/utils/title-generator.test.ts):
  - Tests for basic title generation (date/time format, "Video" prefix)
  - Tests for location handling (included, empty, whitespace-only, trimming, truncation)
  - Tests for different location formats (city, address, coordinates, unicode, special chars)
  - Tests for default date behavior
- Total: 154 tests, all passing (18 new title generator tests)
- Verified: pnpm run build compiles successfully, pnpm test passes (154 tests)

### Task 21: Update storage usage tracking (2026-01-18)
- This task was already implemented as part of Task 17 (video upload endpoint)
- Storage usage tracking implemented in video.service.ts:
  - updateUserStorageUsage() uses Prisma's atomic increment operation (lines 151-162)
  - Supports both positive (add) and negative (subtract) byte changes
  - Uses BigInt for accurate byte-level calculations
- Called after successful upload in video.routes.ts (line 156):
  - updateUserStorageUsage(user.id, fileSizeBytes) called after createVideo()
- Concurrent upload safety:
  - Prisma's increment operation is atomic at database level
  - No race conditions between concurrent uploads
- Existing unit tests verify:
  - Storage increment with positive values
  - Storage decrement with negative values
  - Quota checking with various scenarios
- Total: 154 tests, all passing
- Verified: pnpm run build compiles successfully, pnpm test passes (154 tests)

### Task 22: Calculate distribution timestamp (2026-01-18)
- Created src/utils/distribution.ts with distribution timestamp utilities:
  - calculateDistributeAt(): Adds user's timer days to upload time
    - Takes optional fromDate parameter for testing
    - Returns Date object for scheduled distribution time in UTC
    - Does not mutate input date
  - shouldDistribute(): Checks if video should be distributed (distributeAt <= now)
    - Used by background jobs to find videos ready for distribution
  - calculateExpiresAt(): Calculates expiration (7 days after distribution)
    - Used for automatic video cleanup after distribution
- Updated src/utils/index.ts to export new functions
- Updated src/routes/video.routes.ts:
  - Removed inline calculateDistributeAt function
  - Imported calculateDistributeAt from utils module
  - Upload endpoint uses user's default_timer_days setting (line 120)
  - Timestamp stored in UTC (JavaScript Date + Prisma)
- Created comprehensive unit tests (src/utils/distribution.test.ts):
  - Tests for calculateDistributeAt(): basic functionality, edge cases (month/year boundaries, leap year), typical timer settings
  - Tests for shouldDistribute(): past/future/exact time comparisons, millisecond precision
  - Tests for calculateExpiresAt(): basic functionality, edge cases
  - Integration test for full distribution lifecycle (upload -> distribution -> expiration)
- Total: 180 tests, all passing (26 new distribution tests)
- Verified: pnpm run build compiles successfully, pnpm test passes (180 tests)

### Task 23: Implement failed upload cleanup (2026-01-18)
- Created src/services/cleanup.service.ts with comprehensive cleanup functionality:
  - cleanupFile(): Deletes a single file from disk safely (handles errors gracefully)
  - findOrphanedFiles(): Scans storage directories to find files not in database
  - cleanupOrphanedFiles(): Removes orphaned files older than maxAgeMs (default 1 hour)
    - Skips hidden directories (like .temp) during scanning
    - Only deletes files older than threshold to avoid removing in-progress uploads
    - Returns CleanupResult with filesRemoved, bytesFreed, and errors
  - cleanupTempFiles(): Cleans up old files in the .temp directory
  - runFullCleanup(): Runs both orphaned and temp file cleanup
- Existing cleanup in video.routes.ts was already handling:
  - Cleanup on quota exceeded after file upload (line 99)
  - Cleanup on any server error during processing (line 174)
  - Database records only created after successful file processing
  - Storage usage only incremented after successful video creation
- The cleanup service adds:
  - Periodic cleanup capability for orphaned files (to be called by job scheduler in Task 61)
  - Recovery from server crashes/restarts where uploads were interrupted
  - Safe handling of concurrent uploads (1 hour age threshold)
- Created comprehensive unit tests (src/services/cleanup.service.test.ts):
  - Tests for cleanupFile(): file exists, doesn't exist, error handling
  - Tests for findOrphanedFiles(): empty storage, identifying orphans, skipping .temp
  - Tests for cleanupOrphanedFiles(): age filtering, cleanup tracking, error handling
  - Tests for cleanupTempFiles(): directory missing, old files, skip directories
  - Tests for runFullCleanup(): combining results, aggregating errors
- Total: 196 tests, all passing (16 new cleanup service tests)
- Verified: pnpm run build compiles successfully, pnpm test passes (196 tests)

### Task 24: Write upload integration tests (2026-01-19)
- Video upload integration tests already existed in src/routes/video.routes.test.ts
- Fixed TypeScript errors by adding non-null assertions to handler extraction
- Fixed test isolation issue by changing jest.clearAllMocks() to jest.resetAllMocks()
  - clearAllMocks only clears call history, not mock implementations
  - mockResolvedValueOnce queues persist between tests unless reset
  - This was causing "Different file types" tests to fail due to leftover rejected mocks
- Fixed quota check test logic (single mock response instead of double)
- Test coverage includes:
  - Authentication requirements (requireAuth middleware)
  - Pre-upload quota validation (reject users with no quota left)
  - File upload handling (Multer middleware integration)
  - Video processing:
    - No file uploaded returns 400
    - Post-upload quota validation
    - User-provided titles preserved
    - Auto-generated titles (with/without location)
    - Storage usage tracking
    - Timer days calculation
    - Complete response metadata validation
  - Quota exceeded scenarios (detailed error messages with quota info)
  - Error handling (database errors, cleanup on failure)
  - Different file types (MOV from iOS, WebM)
- Total: 224 tests, all passing (28 video upload integration tests)
- Verified: pnpm run build compiles successfully, pnpm test passes (224 tests)

### Task 25: Implement video list endpoint (2026-01-19)
- Created GET /api/videos endpoint in src/routes/video.routes.ts:
  - Requires authentication via requireAuth middleware
  - Query parameters:
    - status: Filter by VideoStatus (PENDING, ACTIVE, DISTRIBUTED, EXPIRED)
    - limit: Number of videos to return (default: 50, max: 100)
    - offset: Number of videos to skip (default: 0)
  - Returns 400 for invalid query parameters:
    - Invalid status values with list of valid options
    - Non-numeric or negative limit/offset values
  - Response format matches API specification:
    - videos: Array of video objects with snake_case field names
    - total: Total count of matching videos (for pagination)
  - Video objects include all metadata:
    - id, title, file_size_bytes, mime_type, status
    - distribute_at, distributed_at (null if not distributed), expires_at (null if not set)
    - public_token, created_at, updated_at
  - Uses existing getVideosByUser() service function
- Created comprehensive unit tests for GET /api/videos:
  - Authentication tests (requires auth, proceeds when authenticated)
  - Basic listing tests (empty list, correct format, distributed_at/expires_at inclusion)
  - Status filtering tests (all 4 statuses, invalid status rejection)
  - Pagination tests (default limit, custom limit, limit cap at 100, offset, combined params)
  - Validation tests (invalid limit, invalid offset, zero offset allowed)
  - Error handling tests (500 on database error)
- Total: 246 tests, all passing (22 new video list endpoint tests)
- Verified: pnpm run build compiles successfully, pnpm test passes (246 tests)

### Task 26: Implement single video endpoint (2026-01-19)
- Created GET /api/videos/:id endpoint in src/routes/video.routes.ts:
  - Requires authentication via requireAuth middleware
  - Uses findVideoById() service function to fetch video
  - Returns 404 for non-existent video with clear error message
  - Returns 403 for videos owned by other users (ownership validation)
  - Returns complete video metadata for valid ID owned by user:
    - id, title, file_size_bytes, mime_type, status
    - distribute_at, distributed_at (null if not distributed), expires_at (null if not set)
    - public_token, created_at, updated_at
  - Response format matches API specification with snake_case fields
  - Logs unauthorized access attempts for security auditing
- Added findVideoById import to video routes
- Used typed Request<{ id: string }> for proper TypeScript typing of path parameter
- Created comprehensive unit tests for GET /api/videos/:id:
  - Authentication tests (requires auth, proceeds when authenticated)
  - Video retrieval tests (valid ID, distributed video with timestamps, 404 for non-existent)
  - Ownership validation tests (403 for other user's video, allows own video)
  - Error handling tests (500 on database error)
- Total: 254 tests, all passing (8 new single video endpoint tests)
- Verified: pnpm run build compiles successfully, pnpm test passes (254 tests)

### Task 27: Implement video update endpoint (2026-01-19)
- Created PATCH /api/videos/:id endpoint in src/routes/video.routes.ts:
  - Requires authentication via requireAuth middleware
  - Validates request body:
    - Returns 400 if title is not a string
    - Returns 400 if title is empty or only whitespace
  - Fetches video to check ownership before updating
  - Returns 404 for non-existent video with clear error message
  - Returns 403 for videos owned by other users (ownership validation)
  - Trims whitespace from title before saving
  - If no title provided in body, returns video unchanged (no update performed)
  - Uses updateVideoTitle() service function for database update
  - Handles race condition where video is deleted between existence check and update
  - Returns complete video metadata matching API specification:
    - id, title, file_size_bytes, mime_type, status
    - distribute_at, distributed_at (null if not distributed), expires_at (null if not set)
    - public_token, created_at, updated_at
  - Logs update operations and unauthorized access attempts
- Added updateVideoTitle import to video routes
- Fixed getRouteStack test helper to correctly find routes when multiple routes share same path pattern
  - Now checks if route has handlers for the requested HTTP method
  - Required for testing both GET /:id and PATCH /:id endpoints
- Created comprehensive unit tests for PATCH /api/videos/:id (15 new tests):
  - Authentication tests (requires auth, proceeds when authenticated)
  - Request validation tests (invalid title type, empty string, whitespace only)
  - Video retrieval tests (404 for non-existent)
  - Ownership validation tests (403 for other user's video)
  - Title update tests (successful update, whitespace trimming, no title returns unchanged, complete metadata, distributed timestamps)
  - Error handling tests (500 on findVideoById error, 500 on updateVideoTitle error, race condition handling)
- Total: 269 tests, all passing (15 new video update endpoint tests)
- Verified: pnpm run build compiles successfully, pnpm test passes (269 tests)

### Task 28: Implement video delete endpoint (2026-01-19)
- Created DELETE /api/videos/:id endpoint in src/routes/video.routes.ts:
  - Requires authentication via requireAuth middleware
  - Fetches video to check ownership before deletion
  - Returns 404 for non-existent video with clear error message
  - Returns 403 for videos owned by other users (ownership validation)
  - Deletes video file from storage using cleanupFile from cleanup service
  - Handles case where file doesn't exist on disk (still proceeds with DB deletion)
  - Deletes database record using deleteVideo from video service
  - Decrements user's storage_used_bytes by the deleted video's file size
  - Handles race condition where video is deleted between check and delete
  - Returns { success: true } on successful deletion
  - Logs deletion operations and unauthorized access attempts
- Added imports for cleanupFile from cleanup service and getStorageConfig from storage
- Consolidated duplicate storage imports
- Created comprehensive unit tests for DELETE /api/videos/:id (12 new tests):
  - Authentication tests (requires auth, proceeds when authenticated)
  - Video retrieval tests (404 for non-existent video)
  - Ownership validation tests (403 for other user's video)
  - Successful deletion tests (deletes file and DB record, decrements storage, handles missing file, different file paths)
  - Race condition handling tests (404 when video deleted between check and delete)
  - Error handling tests (500 on findVideoById error, 500 on deleteVideo error, 500 on updateUserStorageUsage error)
- Fixed test infrastructure: storage mock needed to be properly reset in beforeEach with mockReturnValue
- Total: 281 tests, all passing (12 new video delete endpoint tests)
- Verified: pnpm run build compiles successfully, pnpm test passes (281 tests)

### Task 29: Add ownership validation (2026-01-19)
- Task verified as already complete - ownership validation was implemented as part of Tasks 26, 27, and 28
- GET /api/videos/:id (lines 313-323): Checks video.userId !== user.id, returns 403
- PATCH /api/videos/:id (lines 402-412): Checks existingVideo.userId !== user.id, returns 403
- DELETE /api/videos/:id (lines 499-509): Checks video.userId !== user.id, returns 403
- GET /api/videos (list endpoint): Implicitly secure - uses getVideosByUser(user.id) which filters by user
- All endpoints log unauthorized access attempts for security auditing
- Comprehensive tests already exist for each endpoint verifying 403 responses
- No code changes required - marked as FINISHED
- Verified: pnpm run build compiles successfully, pnpm test passes (281 tests)

### Task 30: Write video management unit tests (2026-01-19)
- Task verified as already complete - tests were written as part of Tasks 24-28
- 85 test cases in src/routes/video.routes.test.ts covering:
  - POST /upload (28 tests): Authentication, quota validation, file handling, title generation
  - GET / (22 tests): Authentication, pagination, status filtering, validation
  - GET /:id (8 tests): Authentication, video retrieval, ownership validation, error handling
  - PATCH /:id (15 tests): Authentication, validation, ownership, title updates, error handling
  - DELETE /:id (12 tests): Authentication, ownership, file deletion, storage updates
- Tests cover all CRUD operations, ownership validation, and edge cases
- No code changes required - marked as FINISHED
- Verified: pnpm run build compiles successfully, pnpm test passes (281 tests)

### Task 31: Create CheckIn data model (2026-01-19)
- Task verified as already complete - CheckIn model was created as part of Task 4 (initial schema migration)
- CheckIn model includes all required fields: id, video_id, action, created_at
- CheckInAction enum: PREVENT_DISTRIBUTION, ALLOW_DISTRIBUTION
- Foreign key to videos table with cascade delete
- Index on video_id for efficient queries
- No code changes required - marked as FINISHED

### Tasks 32-36: Implement Check-In System (2026-01-19)
- Created src/services/checkin.service.ts with comprehensive check-in functionality:
  - createCheckIn(): Creates a check-in record in the database
  - getCheckInsByVideoId(): Gets all check-ins for a video (audit trail)
  - performCheckIn(): Main function that creates check-in and updates video in a transaction
    - PREVENT_DISTRIBUTION: Extends distribute_at based on user's timer_days setting
    - ALLOW_DISTRIBUTION: Records the action (video remains ACTIVE status)
  - canPerformCheckIn(): Validates video status (only ACTIVE videos can have check-ins)
  - isValidCheckInAction(): Validates action type (PREVENT_DISTRIBUTION or ALLOW_DISTRIBUTION)
- Created POST /api/videos/:id/checkin endpoint in src/routes/video.routes.ts:
  - Requires authentication via requireAuth middleware
  - Validates action in request body (required, must be string, must be valid action)
  - Returns 404 for non-existent video
  - Returns 403 for videos owned by other users (ownership validation)
  - Returns 409 for non-ACTIVE videos (only ACTIVE videos can have check-ins)
  - Gets user's timer_days setting for distribution extension
  - Performs check-in using checkin.service.performCheckIn()
  - Returns { video: {...}, checkin: {...} } matching API specification
- Created comprehensive unit tests (src/services/checkin.service.test.ts):
  - Tests for createCheckIn(), getCheckInsByVideoId(), performCheckIn()
  - Tests for canPerformCheckIn() (all video statuses)
  - Tests for isValidCheckInAction() (valid and invalid actions)
- Created comprehensive integration tests in src/routes/video.routes.test.ts:
  - Authentication tests (requires auth, proceeds when authenticated)
  - Request validation tests (missing action, non-string action, invalid action)
  - Video retrieval tests (404 for non-existent video)
  - Ownership validation tests (403 for other user's video)
  - Video status validation tests (409 for DISTRIBUTED, PENDING, EXPIRED)
  - Successful check-in tests (both action types, timer days usage, complete response)
  - Error handling tests (findVideoById error, performCheckIn error, getUserDefaultTimerDays error)
- Total: 316 tests, all passing (35 new tests)
- Verified: pnpm run build compiles successfully, pnpm test passes (316 tests)

### Task 37: Implement public video endpoint (2026-01-20)
- Task was already implemented - verified existing implementation
- Created GET /api/public/videos/:token endpoint in src/routes/public.routes.ts:
  - Endpoint accessible without authentication (no requireAuth middleware)
  - Uses findVideoByPublicToken() to look up video by public token
  - Returns 404 for non-existent tokens
  - Returns 404 for PENDING or ACTIVE videos ("not available yet")
  - Returns 410 for EXPIRED videos
  - Returns video file stream for DISTRIBUTED videos
  - Sets proper Content-Type, Content-Length, Accept-Ranges headers
  - Sets Content-Disposition with sanitized filename
  - Handles file not found on disk gracefully
  - Handles stream errors gracefully
- Route mounted at /api/public in src/index.ts
- Fixed TypeScript issues in public.routes.ts:
  - Added explicit Promise<void> return type
  - Changed returns to use void pattern (res.json(); return;)
- Fixed TypeScript issues in public.routes.test.ts:
  - Fixed errorCallback type casting for stream error tests
- Created comprehensive unit tests (src/routes/public.routes.test.ts):
  - Video lookup tests (404 for non-existent, finds by token)
  - Video status validation tests (404 for PENDING/ACTIVE, 410 for EXPIRED, serves DISTRIBUTED)
  - File serving tests (404 for missing file, correct headers, streaming, path construction)
  - Error handling tests (500 on database error, stream error handling, headers-sent check)
  - Different MIME types tests (MOV, WebM)
- Total: 334 tests, all passing (18 new public routes tests)
- Verified: npm run build compiles successfully, npm test passes (334 tests)

### Task 38: Validate distribution status (2026-01-20)
- Task verified as already complete - distribution status validation was implemented as part of Task 37
- Implementation in src/routes/public.routes.ts:
  - Lines 46-56: PENDING/ACTIVE videos return 404 with "not available yet" message
  - Lines 58-65: EXPIRED videos return 410 Gone with "no longer available" message
  - Lines 67-104: DISTRIBUTED videos are served via file streaming
- Comprehensive tests already exist in src/routes/public.routes.test.ts:
  - "should return 404 for PENDING videos" (lines 183-201)
  - "should return 404 for ACTIVE videos" (lines 204-222)
  - "should return 410 for EXPIRED videos" (lines 225-242)
  - "should serve DISTRIBUTED videos" (lines 244-265)
- No code changes required - marked as FINISHED
- Verified: npm run build compiles successfully, npm test passes (334 tests)

### Task 39: Stream video with proper headers (2026-01-20)
- Task verified as already complete - video streaming was implemented as part of Task 37
- Implementation in src/routes/public.routes.ts:
  - Line 89: Sets Content-Type header from video.mimeType
  - Line 90: Sets Content-Length header from file stats
  - Line 91: Sets Accept-Ranges header for seeking support
  - Lines 94-95: Sets Content-Disposition with sanitized filename
  - Lines 103-104: Streams video file via fs.createReadStream().pipe(res)
- Comprehensive tests already exist in src/routes/public.routes.test.ts:
  - "should set correct Content-Type header" (lines 287-310)
  - "should set correct Content-Length header" (lines 312-333)
  - "should set Accept-Ranges header for seeking support" (lines 335-355)
  - "should stream video file to response" (lines 386-408)
  - Different MIME type tests for MOV and WebM files (lines 533-592)
- No code changes required - marked as FINISHED
- Verified: npm run build compiles successfully, npm test passes (334 tests)

### Task 40: Handle range requests (2026-01-20)
- Implemented HTTP Range header support for video seeking in src/routes/public.routes.ts:
  - Created parseRangeHeader() helper function to parse "bytes=start-end" or "bytes=start-" format
  - Validates range bounds against file size
  - Returns null for invalid ranges (invalid format, start >= fileSize, end >= fileSize, start > end)
- Updated GET /api/public/videos/:token endpoint:
  - Returns 206 Partial Content for valid range requests
  - Sets Content-Range header in format "bytes start-end/total"
  - Sets Content-Length to the chunk size being returned
  - Passes start/end options to fs.createReadStream() for efficient partial reads
  - Returns 416 Range Not Satisfiable for invalid ranges with "bytes */fileSize" header
  - Continues to support full file requests (200 OK) when no Range header present
- Created comprehensive unit tests in src/routes/public.routes.test.ts:
  - Tests for valid range requests (206 response, correct headers)
  - Tests for open-ended ranges (bytes=start-)
  - Tests for passing start/end to createReadStream
  - Tests for 416 responses (invalid format, start >= fileSize, end >= fileSize, start > end)
  - Tests for Accept-Ranges and Content-Disposition headers in range response
  - Tests for stream error handling during range request
  - Tests for parseRangeHeader() helper function (12 test cases)
- Total: 357 tests, all passing (23 new tests)
- Verified: npm run build compiles successfully, npm test passes (357 tests)

### Task 41: Add rate limiting (2026-01-20)
- Created src/middleware/rate-limiter.ts with comprehensive rate limiting functionality:
  - RateLimiterStore class: In-memory store with automatic cleanup of expired entries
  - createRateLimiter(): Factory function to create rate limiting middleware
    - Configurable maxRequests, windowMs, and custom message
    - Custom key generator support (default: IP-based)
    - Skip function for conditional rate limiting
    - Optional rate limit headers (X-RateLimit-Limit, X-RateLimit-Remaining, X-RateLimit-Reset)
  - publicVideoRateLimiter: Pre-configured limiter for public video access (100 req/15 min per IP)
  - publicVideoDownloadRateLimiter: Stricter limiter per IP+token (10 req/min)
  - resetRateLimiterStore(): Helper for testing
- Applied rate limiting to public video routes in src/routes/public.routes.ts:
  - Added middleware import from ../middleware
  - Applied publicVideoRateLimiter to /videos path
  - Updated endpoint documentation with rate limit response headers and 429 status
- Updated src/middleware/index.ts to export rate limiter functions
- Implementation features:
  - Uses in-memory storage (no Redis dependency for simplicity)
  - Supports X-Forwarded-For header for proxied requests
  - Periodic cleanup of expired entries (every 60 seconds)
  - Returns 429 Too Many Requests with Retry-After header when exceeded
  - Rate limit applies per IP address for the public video endpoint
- Created comprehensive unit tests (src/middleware/rate-limiter.test.ts):
  - Tests for createRateLimiter(): basic functionality, headers, 429 responses, custom messages
  - Tests for key generation: IP-based, X-Forwarded-For, custom generators
  - Tests for window behavior: reset after expiration
  - Tests for pre-configured limiters: publicVideoRateLimiter, publicVideoDownloadRateLimiter
  - Tests for remaining count: shows 0 at limit, never negative
- Total: 379 tests, all passing (22 new rate limiter tests)
- Verified: npm run build compiles successfully, npm test passes (379 tests)

### Task 42: Write public access integration tests (2026-01-20)
- Task verified as already complete - integration tests were written during Tasks 37-41 implementation
- Comprehensive test suite exists in src/routes/public.routes.test.ts (18 tests)
- Valid token access tests:
  - Video lookup by public token
  - Successful video serving for DISTRIBUTED status
  - File streaming with correct path construction
- Invalid/expired token scenarios:
  - 404 for non-existent tokens
  - 404 for PENDING videos (not yet available)
  - 404 for ACTIVE videos (not yet available)
  - 410 for EXPIRED videos
  - 404 for missing file on disk
- Range request handling tests:
  - 206 Partial Content for valid range requests
  - Correct Content-Range header format
  - Open-ended range support (bytes=start-)
  - Start/end options passed to createReadStream
  - 416 Range Not Satisfiable for invalid format
  - 416 for range starting beyond file size
  - 416 for range with end beyond file size
  - 416 for start > end
  - Accept-Ranges and Content-Disposition headers in range response
  - Stream error handling during range request
- Additional tests:
  - Different MIME types (MOV, WebM)
  - Content-Type, Content-Length, Accept-Ranges headers
  - Content-Disposition with sanitized filename
  - Database error handling (500)
  - Stream error handling with headersSent check
- Total: 379 tests, all passing (no new tests needed - already complete)
- Verified: npm run build compiles successfully, npm test passes (379 tests)

### Task 43: Implement get settings endpoint (2026-01-20)
- Created src/routes/user.routes.ts with GET /api/user/settings endpoint:
  - Requires authentication via requireAuth middleware
  - Uses findUserById() to fetch full user data from database
  - Returns 404 if user not found (edge case for deleted user)
  - Returns settings matching API specification:
    - default_timer_days: number
    - storage_quota_bytes: string (BigInt serialized)
    - storage_used_bytes: string (BigInt serialized)
    - fcm_token: string | null
- Updated src/routes/index.ts to export userRoutes
- Updated src/index.ts to mount user routes at /api/user
- Created comprehensive unit tests (src/routes/user.routes.test.ts):
  - Authentication tests (requires auth, proceeds when authenticated)
  - Settings fetching tests (all fields, null fcm_token, BigInt serialization, timer days)
  - Error handling tests (404 for user not found, 500 on database error)
  - User ID from authenticated user test
- Total: 388 tests, all passing (9 new user routes tests)
- Verified: npm run build compiles successfully, npm test passes (388 tests)

### Task 44: Implement update settings endpoint (2026-01-26)
- Created PATCH /api/user/settings endpoint in src/routes/user.routes.ts:
  - Requires authentication via requireAuth middleware
  - Accepts optional fields: default_timer_days (number), fcm_token (string | null)
  - Validates default_timer_days:
    - Must be a number
    - Must be an integer
    - Must be at least 1
    - Cannot exceed 365
  - Validates fcm_token:
    - Must be a string (or null to clear)
  - If no fields provided, returns current settings without update
  - Uses updateUser() from user service to persist changes
  - Returns { settings: { default_timer_days, storage_quota_bytes, storage_used_bytes, fcm_token } }
  - Returns 400 for invalid request body
  - Returns 404 if user not found
  - Returns 500 on database error
- Added import for updateUser from user.service
- Created comprehensive unit tests in src/routes/user.routes.test.ts:
  - Authentication tests (requires auth, proceeds when authenticated)
  - Request validation tests for default_timer_days (non-number, non-integer, < 1, negative, > 365)
  - Request validation tests for fcm_token (non-string, null accepted)
  - No fields provided tests (returns current settings, 404 for user not found)
  - Successful update tests (timer days, fcm_token, both fields, min/max values, complete response)
  - Error handling tests (404 on user not found, 500 on database error)
  - User ID from authenticated user test
- Total: 408 tests, all passing (20 new user settings tests)
- Verified: pnpm run build compiles successfully, pnpm test passes (408 tests)

### Task 45: Implement get recipients endpoint (2026-01-26)
- Created src/services/recipient.service.ts with recipient management functions:
  - getRecipientsByUserId(): Gets all recipients for a user ordered by creation date desc
  - findRecipientById(): Finds a recipient by ID
  - createRecipient(): Creates a new recipient with email and optional name
  - deleteRecipient(): Deletes a recipient, returns true if deleted, false if not found
  - recipientEmailExists(): Case-insensitive check if email already exists for user
- Created GET /api/user/recipients endpoint in src/routes/user.routes.ts:
  - Requires authentication via requireAuth middleware
  - Uses getRecipientsByUserId() to fetch recipients for authenticated user
  - Returns list of recipients with id, email, name fields
  - Does not include userId or createdAt in response (API specification compliance)
  - Returns 401 for unauthenticated requests
  - Returns 500 on database errors
- Created comprehensive unit tests for recipient service (src/services/recipient.service.test.ts):
  - Tests for getRecipientsByUserId(): fetching, empty results, ordering
  - Tests for findRecipientById(): found and not found cases
  - Tests for createRecipient(): with name, without name, empty name handling
  - Tests for deleteRecipient(): success, not found (P2025), other errors
  - Tests for recipientEmailExists(): exists, not exists, case-insensitive comparison
- Created comprehensive unit tests for GET /api/user/recipients in src/routes/user.routes.test.ts:
  - Authentication tests (requires auth, proceeds when authenticated)
  - Fetching tests (empty array, all fields, null name, excludes userId/createdAt)
  - Error handling tests (500 on database error)
  - User ID from authenticated user test
- Total: 430 tests, all passing (22 new tests)
- Verified: pnpm run build compiles successfully, pnpm test passes (430 tests)

### Task 46: Implement add recipient endpoint (2026-01-26)
- Created POST /api/user/recipients endpoint in src/routes/user.routes.ts:
  - Requires authentication via requireAuth middleware
  - Validates email field:
    - Required (returns 400 if missing)
    - Must be a string (returns 400 if not)
    - Cannot be empty or whitespace-only (returns 400)
    - Must match basic email format regex (returns 400 for invalid format)
  - Validates name field (optional):
    - Must be a string if provided (returns 400 if not)
    - Null is accepted to indicate no name
  - Trims whitespace from email and name
  - Checks for duplicate emails case-insensitively using recipientEmailExists()
  - Returns 409 Conflict if email already exists for user
  - Creates recipient using createRecipient() from recipient service
  - Returns 201 Created with { recipient: { id, email, name } }
  - Does not include userId or createdAt in response (API specification compliance)
  - Returns 500 on database errors
- Added imports for createRecipient and recipientEmailExists to user routes
- Created comprehensive unit tests in src/routes/user.routes.test.ts (23 new tests):
  - Authentication tests (requires auth, proceeds when authenticated)
  - Email validation tests (missing, null, non-string, empty, whitespace, invalid formats)
  - Name validation tests (non-string, null accepted)
  - Duplicate email handling tests (409 response, createRecipient not called)
  - Successful creation tests (email only, email and name, whitespace trimming)
  - Empty/whitespace name treated as undefined tests
  - Response format tests (excludes userId/createdAt)
  - Error handling tests (recipientEmailExists error, createRecipient error)
  - User ID from authenticated user tests
- Total: 453 tests, all passing (23 new tests)
- Verified: pnpm run build compiles successfully, pnpm test passes (453 tests)

### Task 47: Implement delete recipient endpoint (2026-01-26)
- Created DELETE /api/user/recipients/:id endpoint in src/routes/user.routes.ts:
  - Requires authentication via requireAuth middleware
  - Looks up recipient by ID using findRecipientById()
  - Returns 404 if recipient not found
  - Validates ownership: returns 403 if recipient belongs to another user
  - Deletes recipient using deleteRecipient() from recipient service
  - Handles race condition where recipient deleted between find and delete (404)
  - Returns { success: true } on successful deletion
  - Returns 500 on database errors
- Added imports for findRecipientById and deleteRecipient to user routes
- Created comprehensive unit tests in src/routes/user.routes.test.ts (10 new tests):
  - Authentication tests (requires auth, proceeds when authenticated)
  - Recipient lookup tests (404 for non-existent recipient)
  - Ownership validation tests (403 for other user's recipient, allows own recipient)
  - Successful deletion tests (delete and return success, race condition handling)
  - Error handling tests (500 on findRecipientById error, 500 on deleteRecipient error)
  - User ID from authenticated user test
- Total: 463 tests, all passing (10 new tests)
- Verified: pnpm run build compiles successfully, pnpm test passes (463 tests)

### Task 48: Validate recipient ownership (2026-01-26)
- Task implemented as part of Task 47 (delete recipient endpoint)
- Implementation in src/routes/user.routes.ts:
  - GET /api/user/recipients: Implicitly secure - uses getRecipientsByUserId(authUser.id) which filters by authenticated user
  - POST /api/user/recipients: Implicitly secure - creates recipient with authUser.id as owner
  - DELETE /api/user/recipients/:id: Explicitly validates ownership (lines 290-295)
    - Checks recipient.userId !== authUser.id
    - Returns 403 with "You do not have permission to delete this recipient"
    - Logs unauthorized deletion attempts for security auditing
- Comprehensive tests verify 403 responses for unauthorized access
- No additional code changes required - marked as FINISHED
- Verified: pnpm run build compiles successfully, pnpm test passes (463 tests)

### Task 49: Write settings and recipients unit tests (2026-01-26)
- Task verified as already complete - tests were written during Tasks 43-48 implementation
- Comprehensive test coverage exists:
  - src/routes/user.routes.test.ts: 70 test cases covering GET/PATCH settings, GET/POST/DELETE recipients
  - src/services/recipient.service.test.ts: 14 test cases covering all service functions
- Tests cover all settings operations, recipient CRUD operations, validation and authorization
- No additional code changes required - marked as FINISHED
- Verified: pnpm run build compiles successfully, pnpm test passes (463 tests)

### Tasks 50-53: Implement Admin User Endpoints (2026-01-26)
- Created src/routes/admin.routes.ts with all admin user management endpoints:
  - POST /api/admin/users: Create new user with admin-only access
    - Validates username (required, 3-50 chars, unique)
    - Validates password (required, min 8 chars)
    - Optional is_admin (boolean) and storage_quota_bytes (positive number)
    - Returns 409 if username exists
    - Returns created user without password
  - GET /api/admin/users: List all users with admin-only access
    - Returns all users with id, username, is_admin, storage stats, created_at
    - Does not include passwords in response
  - PATCH /api/admin/users/:id: Update user properties with admin-only access
    - Accepts optional is_admin (boolean) and storage_quota_bytes (positive number)
    - Returns 404 if user not found
    - Returns updated user
  - DELETE /api/admin/users/:id: Delete user with admin-only access
    - Cascade deletes related records (videos, recipients) via Prisma schema
    - Returns 404 if user not found
    - Returns { success: true }
- All endpoints use requireAuth and requireAdmin middleware for authorization
- Updated src/routes/index.ts to export adminRoutes
- Updated src/index.ts to mount admin routes at /api/admin
- Created comprehensive unit tests (src/routes/admin.routes.test.ts):
  - Authentication and authorization tests for all endpoints
  - Request validation tests (username, password, is_admin, storage_quota_bytes)
  - Duplicate username handling tests
  - Successful CRUD operation tests
  - Error handling tests
- Total: 509 tests, all passing (46 new admin routes tests)
- Verified: pnpm run build compiles successfully, pnpm test passes (509 tests)

### Task 54: Implement get system config endpoint (2026-01-27)
- Created src/services/config.service.ts with system configuration management:
  - DEFAULT_CONFIG: Default values for storage quota, notification time, expiration days, check interval
  - getConfigValue(): Get single config value with default fallback
  - getAllConfig(): Get all config values (merged defaults with stored values)
  - setConfigValue(): Upsert single config value
  - setConfigValues(): Update multiple values in a transaction
  - deleteConfigValue(): Delete a config value
- Created GET /api/admin/config endpoint in src/routes/admin.routes.ts:
  - Requires authentication and admin privileges
  - Returns all system configuration values as { config: { key: value, ... } }
  - Merges default values with stored database values
  - Returns 401 for unauthenticated requests
  - Returns 403 for non-admin users
  - Returns 500 on database errors
- Created comprehensive unit tests (src/services/config.service.test.ts):
  - Tests for getConfigValue(), getAllConfig(), setConfigValue(), setConfigValues(), deleteConfigValue()
  - Tests for default value handling and error cases
- Added tests for GET /config endpoint in src/routes/admin.routes.test.ts:
  - Authentication and authorization tests
  - Config retrieval tests (all values, merged values, empty config)
  - Error handling tests
- Total: 527 tests, all passing (18 new tests)
- Verified: pnpm run build compiles successfully, pnpm test passes (527 tests)

### Task 55: Implement update system config endpoint (2026-01-27)
- Created PATCH /api/admin/config endpoint in src/routes/admin.routes.ts:
  - Requires authentication and admin privileges
  - Accepts arbitrary key-value pairs (all values must be strings)
  - Validates request body is an object (returns 400 for arrays, null, primitives)
  - Validates all config values are strings (returns 400 with specific key for non-strings)
  - Skips null/undefined values and empty string keys gracefully
  - If no valid values to update, returns current config without database write
  - Uses setConfigValues() from config service for atomic updates
  - Returns updated configuration immediately after changes
  - Returns 401 for unauthenticated requests
  - Returns 403 for non-admin users
  - Returns 500 on database errors
- Added import for setConfigValues in admin.routes.ts
- Created comprehensive unit tests in src/routes/admin.routes.test.ts (20 new tests):
  - Authentication and authorization tests (3 tests)
  - Request validation tests: non-object body, array body, null body, non-string values, boolean values, object values (6 tests)
  - Empty/no-op update tests: empty body, null values, undefined values, empty string keys (4 tests)
  - Successful update tests: single value, multiple values, custom keys, immediate return, mixed valid/null values (5 tests)
  - Error handling tests: setConfigValues error, getAllConfig error after update (2 tests)
- Total: 547 tests, all passing (20 new tests)
- Verified: pnpm run build compiles successfully, pnpm test passes (547 tests)

### Task 56: Create admin seed script (2026-01-27)
- Created src/scripts/seed-admin.ts with comprehensive admin seeding functionality:
  - Loads environment variables from .env file
  - ADMIN_USERNAME: Optional, defaults to "admin"
  - ADMIN_PASSWORD: Required, must be at least 8 characters
  - Uses bcrypt with 12 rounds for password hashing
  - Creates admin user with 1GB default storage quota
- Script is idempotent (safe to run multiple times):
  - Checks if user with username already exists
  - If admin exists, logs message and skips creation
  - If non-admin user exists, provides guidance on how to make admin
  - Only creates new user if none exists
- Added "seed:admin" pnpm script in package.json:
  - Runs via: pnpm seed:admin
  - Or with inline password: ADMIN_PASSWORD=your-password pnpm seed:admin
- Updated .env.example with ADMIN_USERNAME and ADMIN_PASSWORD documentation
- Script outputs:
  - User ID, username, admin status, storage quota on success
  - Clear error messages with usage instructions on failure
  - Proper exit codes (0 for success, 1 for error)
- Verified: pnpm run build compiles successfully, pnpm test passes (547 tests)

### Task 57: Write admin endpoint integration tests (2026-01-27)
- Task verified as already complete - tests were written during Tasks 50-55 implementation
- Comprehensive test coverage exists in src/routes/admin.routes.test.ts (67 test cases):
  - POST /api/admin/users (17 tests): Authentication, authorization, request validation, duplicate handling, successful creation, error handling
  - GET /api/admin/users (6 tests): Authentication, authorization, listing users, passwords excluded, error handling
  - PATCH /api/admin/users/:id (12 tests): Authentication, authorization, validation, no-op updates, successful updates, error handling
  - DELETE /api/admin/users/:id (5 tests): Authentication, authorization, successful deletion, error handling
  - GET /api/admin/config (7 tests): Authentication, authorization, config retrieval, error handling
  - PATCH /api/admin/config (20 tests): Authentication, authorization, validation, no-op updates, successful updates, error handling
- All tests verify admin-only access via requireAuth + requireAdmin middleware
- Cascade delete handled by Prisma schema (videos, recipients deleted with user)
- No additional code changes required - marked as FINISHED
- Verified: pnpm run build compiles successfully, pnpm test passes (547 tests)

### Task 58: Set up job scheduler (2026-01-27)
- Created src/scheduler/index.ts with comprehensive job scheduling functionality:
  - JobScheduler class: Manages background job scheduling and execution
  - registerJob(): Register jobs with name, cron expression, and handler function
  - unregisterJob(): Remove registered jobs by name
  - start(): Start all registered jobs (with optional runOnStart support)
  - stop(): Stop all running jobs
  - runJobNow(): Execute a job immediately (manual trigger)
  - getStatus(): Get scheduler status including all job states
  - hasJob(), getJobNames(), clear(): Helper methods
- Features implemented:
  - Concurrent execution prevention (skips if job is still running)
  - Run count and error count tracking per job
  - Last run timestamp and last error tracking
  - Timezone support for cron schedules (default: UTC)
  - runOnStart option for jobs that should run immediately on scheduler start
  - Comprehensive logging with structured pino logger
- Singleton pattern with exports:
  - getScheduler(): Get/create scheduler instance
  - initializeScheduler(): Initialize for app startup
  - shutdownScheduler(): Stop and cleanup for app shutdown
  - resetScheduler(): For testing purposes
- Common cron expressions exported as CronExpressions:
  - EVERY_MINUTE, EVERY_5_MINUTES, EVERY_15_MINUTES, EVERY_30_MINUTES
  - HOURLY, DAILY_MIDNIGHT, DAILY_9AM, DAILY_NOON
- Updated src/index.ts:
  - Imported initializeScheduler and shutdownScheduler
  - Scheduler initialized and started after database connection
  - Scheduler shut down during graceful shutdown (before database disconnect)
- Installed @types/node-cron for TypeScript support
- Created comprehensive unit tests (src/scheduler/index.test.ts):
  - Tests for getScheduler(), initializeScheduler(), shutdownScheduler(), resetScheduler()
  - Tests for registerJob(): success, duplicate names, invalid cron, options
  - Tests for unregisterJob(): success, non-existent
  - Tests for start(): all jobs, runOnStart, already running
  - Tests for stop(): all jobs, not started
  - Tests for runJobNow(): success, not found, already running, handler failure, tracking
  - Tests for getStatus(): no jobs, with jobs, lastError
  - Tests for hasJob(), getJobNames(), clear()
  - Tests for concurrent execution prevention
  - Tests for CronExpressions values
- Total: 581 tests, all passing (34 new scheduler tests)
- Verified: pnpm run build compiles successfully, pnpm test passes (581 tests)

### Task 59: Create distribution job (2026-01-27)
- Created src/jobs/distribution.job.ts with distribution job implementation:
  - DistributionJobResult interface: tracks processed, distributed, failed counts, and errors
  - processDistribution(): Main function that queries ACTIVE videos with distribute_at <= now
    - Updates status to DISTRIBUTED
    - Sets distributedAt to current time
    - Sets expiresAt to 7 days after distribution
    - Handles partial failures gracefully (continues processing other videos)
    - Returns comprehensive result with success/failure counts
  - distributionJobHandler(): Entry point for scheduler
- Created src/jobs/index.ts as jobs module entry point:
  - Exports job handlers and types
  - JobNames constant with DISTRIBUTION key
  - registerAllJobs(): Registers all background jobs with scheduler
    - Distribution job registered with hourly cron expression (0 * * * *)
    - runOnStart: false to avoid unexpected distributions on startup
- Updated src/index.ts:
  - Import registerAllJobs from jobs module
  - Call registerAllJobs() after scheduler initialization
- Created comprehensive unit tests (src/jobs/distribution.job.test.ts):
  - Tests for processDistribution(): empty results, query parameters, time handling
  - Tests for single video distribution: success, expires_at calculation
  - Tests for multiple videos: success, partial failures, all failures
  - Tests for error handling: findMany failure, non-Error objects
  - Tests for distributionJobHandler(): success, partial failure, throws on critical error
- Created unit tests (src/jobs/index.test.ts):
  - Tests for JobNames export
  - Tests for registerAllJobs(): job registration, cron expression, runOnStart disabled, duplicate registration
- Total: 602 tests, all passing (21 new distribution job tests)
- Verified: pnpm run build compiles successfully, pnpm test passes (602 tests)

### Task 60: Create push notification job (2026-01-27)
- Created src/services/notification.service.ts with notification service:
  - CheckInReminderPayload interface: FCM token, user ID, video ID, title, time until distribution
  - NotificationResult interface: success/failure tracking
  - sendCheckInReminder(): Sends single notification (placeholder for Firebase)
  - sendCheckInReminders(): Batch send notifications
  - formatTimeUntilDistribution(): Formats time for display (e.g., "2 days", "5 hours")
  - isFirebaseConfigured(): Placeholder for Task 64 Firebase integration
- Created src/jobs/notification.job.ts with push notification job:
  - NotificationJobResult interface: tracks videos found, notifications sent/skipped/failed
  - processNotifications(): Queries all ACTIVE videos with user FCM tokens
    - Skips users without FCM tokens
    - Sends check-in reminder for each active video
    - Logs results for monitoring
  - notificationJobHandler(): Entry point for scheduler
- Updated src/jobs/index.ts:
  - Added JobNames.PUSH_NOTIFICATIONS constant
  - Registered notification job with DAILY_9AM cron (0 9 * * *)
  - runOnStart: false to avoid unexpected notifications on startup
- Created comprehensive unit tests (src/services/notification.service.test.ts):
  - Tests for sendCheckInReminder(): valid payload, empty token, null token
  - Tests for sendCheckInReminders(): multiple notifications, mixed success/failure, empty array
  - Tests for formatTimeUntilDistribution(): days, hours, minutes, edge cases
  - Tests for isFirebaseConfigured(): returns false (placeholder)
- Created comprehensive unit tests (src/jobs/notification.job.test.ts):
  - Tests for processNotifications(): empty videos, query parameters, FCM token handling
  - Tests for single/multiple notifications, skipped notifications (no token)
  - Tests for error handling: send failure, thrown errors, database errors
  - Tests for notificationJobHandler(): success, partial failure, critical error
- Updated src/jobs/index.test.ts:
  - Added tests for PUSH_NOTIFICATIONS job name
  - Added tests for notification job registration with daily 9am cron
  - Added tests for runOnStart disabled
- Total: 641 tests, all passing (39 new tests)
- Verified: pnpm run build compiles successfully, pnpm test passes (641 tests)

### Task 61: Create expiration cleanup job (2026-01-27)
- Created src/jobs/expiration.job.ts with expiration job implementation:
  - ExpirationJobResult interface: tracks processed, expired, failed counts, bytes freed, and errors
  - processExpiration(): Main function that queries DISTRIBUTED videos with expires_at <= now
    - Deletes video file from storage using cleanupFile()
    - Updates status to EXPIRED
    - Decrements user's storage_used_bytes
    - Tracks total bytes freed across all processed videos
    - Handles partial failures gracefully (continues processing other videos)
    - Returns comprehensive result with success/failure counts
  - expirationJobHandler(): Entry point for scheduler
- Updated src/jobs/index.ts:
  - Added JobNames.EXPIRATION_CLEANUP constant
  - Registered expiration job with DAILY_MIDNIGHT cron (0 0 * * *)
  - runOnStart: false to avoid unexpected deletions on startup
  - Exports processExpiration, expirationJobHandler, and ExpirationJobResult type
- Updated src/test/setup.ts:
  - Added BigInt serialization fix for Jest (BigInt.prototype.toJSON)
- Created comprehensive unit tests (src/jobs/expiration.job.test.ts):
  - Tests for processExpiration(): empty results, query parameters, time handling
  - Tests for single video expiration: success, file path construction, file cleanup
  - Tests for multiple videos: success, partial failures, all failures
  - Tests for error handling: cleanupFile failure, updateUserStorageUsage failure, database errors
  - Tests for bytesFreed tracking, storage decrement calculation
  - Tests for expirationJobHandler(): success, partial failure, critical error
- Updated src/jobs/index.test.ts:
  - Added tests for EXPIRATION_CLEANUP job name
  - Added tests for expiration job registration with daily midnight cron
  - Added tests for runOnStart disabled
  - Updated test for registering all three jobs
- Total: 665 tests, all passing (24 new tests)
- Verified: pnpm run build compiles successfully, pnpm test passes (665 tests)

### Task 62: Add job error handling (2026-01-28)
- Created src/services/alert.service.ts with comprehensive alerting functionality:
  - Alert interface with title, message, severity, source, context, timestamp
  - AlertSeverity type: info, warning, error, critical
  - registerAlertHandler(): Register custom alert handlers (email, Slack, etc.)
  - unregisterAlertHandler(): Remove registered handlers
  - getAlertHandlerNames(): List all registered handlers
  - resetAlertHandlers(): Clear custom handlers, keep default logging
  - sendAlert(): Send alert through all registered handlers
  - alert(): Create and send an alert with auto-generated timestamp
  - alertJobFailure(): Send job failure alert with severity escalation:
    - 1-2 consecutive failures: warning
    - 3-4 consecutive failures: error
    - 5+ consecutive failures: critical
  - alertJobRecovered(): Send recovery alert when job succeeds after failures
- Updated src/scheduler/index.ts with retry logic and alerting:
  - RetryConfig interface: maxRetries, baseDelayMs, exponentialBackoff, maxDelayMs
  - DEFAULT_RETRY_CONFIG: 3 retries, 1s base delay, exponential backoff, 30s max
  - calculateRetryDelay(): Calculate delay with optional exponential backoff
  - isTransientError(): Detect retryable errors (timeout, connection, deadlock)
  - Added consecutiveFailures and lastSuccessfulRun tracking to RegisteredJob
  - executeWithRetry(): Private method for retry logic with transient error detection
  - runJobNow() updated to:
    - Retry transient failures with exponential backoff
    - Track consecutive failures
    - Send failure alerts when alertOnFailure !== false
    - Send recovery alerts when job succeeds after failures
  - createWrappedHandler() updated with same retry and alert logic for scheduled runs
  - JobConfig extended with retry and alertOnFailure options
  - SchedulerStatus extended with consecutiveFailures and lastSuccessfulRun
- Transient error patterns detected:
  - Timeout errors (timeout, timed out, etimedout)
  - Connection errors (connection refused, reset, econnrefused, econnreset)
  - Service availability (temporarily unavailable, too many connections)
  - Database locks (deadlock, lock wait timeout)
- Non-transient errors do not trigger retries (fail fast)
- Created comprehensive unit tests (src/services/alert.service.test.ts):
  - Tests for registerAlertHandler(), unregisterAlertHandler(), getAlertHandlerNames()
  - Tests for resetAlertHandlers(), sendAlert(), alert()
  - Tests for alertJobFailure() severity escalation and context
  - Tests for alertJobRecovered()
- Added scheduler tests (src/scheduler/index.test.ts):
  - Tests for retry configuration (default and custom)
  - Tests for consecutive failure tracking
  - Tests for lastSuccessfulRun tracking
  - Tests for calculateRetryDelay() with/without exponential backoff
  - Tests for isTransientError() with various error types
- Updated test mocks:
  - Added createChildLogger mock to logger mock
  - Added alert service mock for scheduler tests
- Total: 697 tests, all passing (32 new tests)
- Verified: pnpm run build compiles successfully, pnpm test passes (697 tests)

### Task 63: Write job scheduler tests (2026-01-28)
- Task verified as already complete - tests were written during Tasks 58-62 implementation
- Comprehensive test coverage exists across multiple test files:
  - src/scheduler/index.test.ts (34 tests): Scheduler infrastructure tests
  - src/jobs/distribution.job.test.ts (21 tests): Distribution job logic tests
  - src/jobs/notification.job.test.ts (29 tests): Notification job logic tests
  - src/jobs/expiration.job.test.ts (24 tests): Expiration cleanup job logic tests
  - src/jobs/index.test.ts (14 tests): Jobs module and registration tests
- Tests cover all PRD requirements:
  - Distribution job: query logic, status updates, expires_at calculation, partial failures
  - Notification job: FCM token handling, send success/failure, skip without token
  - Expiration cleanup: file cleanup, storage decrement, bytesFreed tracking
  - Error handling: database errors, non-Error objects, partial failures, transient error retry
- No additional code changes required - marked as FINISHED
- Verified: pnpm run build compiles successfully, pnpm test passes (697 tests)

### Task 64: Set up Firebase Admin SDK (2026-01-28)
- Created src/services/firebase.service.ts with comprehensive Firebase Admin SDK integration:
  - isFirebaseConfigured(): Check if Firebase credentials are configured in environment
  - initializeFirebase(): Initialize Firebase Admin SDK with service account credentials
    - Idempotent (safe to call multiple times)
    - Gracefully handles missing credentials (logs info, continues without Firebase)
    - Stores initialization error for debugging
  - getFirebaseApp(): Get Firebase app instance (auto-initializes if needed)
  - getFirebaseMessaging(): Get Firebase messaging instance for sending notifications
  - isFirebaseReady(): Check if Firebase is ready to send notifications
  - shutdownFirebase(): Clean shutdown of Firebase SDK
  - resetFirebase(): Reset state (for testing)
  - sendFcmMessage(): Send push notification via FCM
    - Supports notification payload (title, body)
    - Supports custom data payload for app processing
    - Supports Android-specific options (priority, TTL)
    - Supports iOS-specific options (headers, badge, sound)
    - Returns null when Firebase not available (graceful degradation)
  - validateFcmToken(): Validate FCM token via dry-run send
    - Detects invalid and unregistered tokens
- Updated src/services/notification.service.ts to use Firebase service:
  - sendCheckInReminder() now sends real notifications when Firebase is configured
  - Handles FCM error codes (invalid-registration-token, registration-token-not-registered)
  - Builds complete FCM message with deep linking data
  - Graceful fallback to logging when Firebase not configured
- Updated src/index.ts:
  - Imports and initializes Firebase on startup (after database connection)
  - Shuts down Firebase during graceful shutdown (before database disconnect)
- Created comprehensive unit tests (src/services/firebase.service.test.ts):
  - Tests for isFirebaseConfigured(): all credential combinations
  - Tests for initializeFirebase(): success, skip when not configured, idempotent, error handling
  - Tests for getFirebaseApp(): returns app, null when not configured, auto-initialize
  - Tests for getFirebaseMessaging(): returns messaging, null when not available
  - Tests for shutdownFirebase(): clean shutdown, handles errors
  - Tests for resetFirebase(): resets all state
  - Tests for sendFcmMessage(): success, null when unavailable, error handling, options
  - Tests for validateFcmToken(): valid token, invalid token, unregistered token
- Updated notification service tests to mock firebase.service:
  - Added tests for Firebase-enabled notification sending
  - Added tests for FCM error handling (invalid token, unregistered token)
  - Added tests for messageId in successful response
- Total: 730 tests, all passing (33 new tests)
- Verified: pnpm run build compiles successfully, pnpm test passes (730 tests)

## Next Task
Task 65: Create notification service
